INCLUDE Irvine32.inc

.data
SCREEN_WIDTH = 120
SCREEN_HEIGHT = 30
GROUND_LEVEL = 25
GRAVITY = 1
JUMP_STRENGTH = 4
HIGH_JUMP_STRENGTH = 6

DEFAULT_ATTR = white + (blue * 16)
Level4_ATTR = white +(black*16)
LEVEL1_ATTR = white + (lightBlue * 16)
PIPE_ATTR = white + (green * 16)
BRICK_ATTR = white + (brown * 16)
BOSS_ATTR = white + (red * 16)
BLUE_MARIO = blue + (lightBlue * 16)
DARKGRAY_ATTR = gray + (lightBlue * 16)

gameActive BYTE 1
score DWORD 0
coins BYTE 0
lives BYTE 3
level BYTE 1
screenVersion BYTE 1
timeLeft DWORD 400
worldStr BYTE "1-1", 0
timerCounter BYTE 0

playerName BYTE 50 DUP(0)
nameLength BYTE 0

marioX BYTE 10
marioY BYTE GROUND_LEVEL
marioVelocityY SBYTE 0
isJumping BYTE 0
canDoubleJump BYTE 1
jumpCount BYTE 0
marioState BYTE 0
hasSpringPower BYTE 0
springTimer BYTE 0

springMushroomX BYTE 30
springMushroomY BYTE GROUND_LEVEL - 1
springActive BYTE 1

; BOSS LEVEL 4 VARIABLES
bossX BYTE 100
bossY BYTE GROUND_LEVEL
bossHealth BYTE 5
bossActive BYTE 0
bossDir SBYTE - 1
bossAttackTimer BYTE 0
bossAttackCooldown BYTE 30
bossVulnerable BYTE 0
bossStunTimer BYTE 0
bossPhase BYTE 1

; BOSS PROJECTILES
projectileCount = 3
projectileX BYTE 0, 0, 0
projectileY BYTE 0, 0, 0
projectileActive BYTE 0, 0, 0
projectileDir SBYTE 0, 0, 0

; LEVEL 1 SCREEN 1 DATA
coinCount = 15
coinX BYTE 12, 13, 14, 32, 33, 34, 62, 63, 64, 92, 93, 94, 110, 111, 112
coinY BYTE GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4
coinActive BYTE 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1

goomba1X BYTE 45
goomba1Y BYTE GROUND_LEVEL
goomba1Dir SBYTE 1
goomba1Active BYTE 1

; Add to DATA section after other enemy declarations
koopaX BYTE 70
koopaY BYTE GROUND_LEVEL
koopaDir SBYTE -1
koopaActive BYTE 1
koopaShell BYTE 0  ; 0=normal, 1=shell
shellTimer BYTE 0


platformCount = 6
platformX BYTE 10, 30, 60, 28, 85, 95
platformY BYTE GROUND_LEVEL - 5, GROUND_LEVEL - 8, GROUND_LEVEL - 4, GROUND_LEVEL - 10, GROUND_LEVEL - 6, GROUND_LEVEL - 12
platformWidth BYTE 10, 10, 8, 7, 9, 5

wallCount = 3
wallX BYTE 25, 55, 80
wallYTop BYTE GROUND_LEVEL - 6, GROUND_LEVEL - 8, GROUND_LEVEL - 5
wallYBottom BYTE GROUND_LEVEL, GROUND_LEVEL - 2, GROUND_LEVEL

; LEVEL 1 SCREEN 2 DATA
coinX_L1_S2 BYTE 8, 9, 10, 25, 26, 27, 50, 51, 52, 75, 76, 77, 98, 99, 100
coinY_L1_S2 BYTE GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5
goomba1X_L1_S2 BYTE 55
goomba1Y_L1_S2 BYTE GROUND_LEVEL
koopaX_L1_S2 BYTE 65
koopaY_L1_S2 BYTE GROUND_LEVEL
platformX_L1_S2 BYTE 5, 23, 48, 40, 73, 96
platformY_L1_S2 BYTE GROUND_LEVEL - 7, GROUND_LEVEL - 9, GROUND_LEVEL - 5, GROUND_LEVEL - 11, GROUND_LEVEL - 8, GROUND_LEVEL - 10
platformWidth_L1_S2 BYTE 8, 12, 9, 8, 10, 6
wallX_L1_S2 BYTE 18, 63, 88
wallYTop_L1_S2 BYTE GROUND_LEVEL - 7, GROUND_LEVEL - 9, GROUND_LEVEL - 6
wallYBottom_L1_S2 BYTE GROUND_LEVEL, GROUND_LEVEL - 1, GROUND_LEVEL
springMushroomX_L1_S2 BYTE 35
springMushroomY_L1_S2 BYTE GROUND_LEVEL - 1

; LEVEL 4 BOSS LEVEL DATA
coinX_L4 BYTE 20, 25, 30, 35, 40, 50, 55, 60, 70, 75, 80, 85, 90, 95, 100
coinY_L4 BYTE GROUND_LEVEL - 2, GROUND_LEVEL - 6, GROUND_LEVEL - 10, GROUND_LEVEL - 6, GROUND_LEVEL - 2, GROUND_LEVEL - 8, GROUND_LEVEL - 12, GROUND_LEVEL - 8, GROUND_LEVEL - 5, GROUND_LEVEL - 9, GROUND_LEVEL - 13, GROUND_LEVEL - 9, GROUND_LEVEL - 5, GROUND_LEVEL - 7, GROUND_LEVEL - 3
platformX_L4 BYTE 5, 25, 50, 35, 70, 90
platformY_L4 BYTE GROUND_LEVEL - 8, GROUND_LEVEL - 12, GROUND_LEVEL - 10, GROUND_LEVEL - 15, GROUND_LEVEL - 7, GROUND_LEVEL - 13
platformWidth_L4 BYTE 8, 12, 10, 8, 15, 10
wallX_L4 BYTE 18, 45, 82
wallYTop_L4 BYTE GROUND_LEVEL - 10, GROUND_LEVEL - 12, GROUND_LEVEL - 8
wallYBottom_L4 BYTE GROUND_LEVEL - 3, GROUND_LEVEL - 5, GROUND_LEVEL - 2

cloudCount = 5
cloudX BYTE 10, 35, 60, 85, 100
cloudY BYTE 8, 6, 7, 5, 9
cloudStr BYTE "o-o", 0

strTitle BYTE "SUPER MARIO BROS - 0525", 0
strWelcome BYTE "*** WELCOME TO SUPER MARIO BROS ***", 0
strMenuStart BYTE "1. START GAME", 0
strMenuHighscore BYTE "2. HIGHSCORE", 0
strMenuExit BYTE "3. EXIT", 0
strEnterChoice BYTE "ENTER YOUR CHOICE (1-3): ", 0
strEnterName BYTE "ENTER YOUR NAME: ", 0
strInvalidChoice BYTE "INVALID CHOICE! PRESS ANY KEY...", 0
strScore BYTE "SCORE:", 0
strCoins BYTE "COINS:", 0
strWorld BYTE "WORLD:", 0
strTime BYTE "TIME:", 0
strLife BYTE "LIFE:", 0
strBossHealth BYTE "BOSS HP:", 0
strGameOver BYTE "GAME OVER", 0
strYouDied BYTE "YOU DIED! PRESS ANY KEY", 0
strLevelComplete BYTE "LEVEL COMPLETE!", 0
strBossDefeated BYTE "BOSS DEFEATED!", 0
strAllComplete BYTE "ALL LEVELS COMPLETE!", 0
strPressAnyKey BYTE "PRESS ANY KEY TO START", 0
strNextLevel BYTE "PRESS ANY KEY FOR NEXT LEVEL", 0
strRestart BYTE "PRESS R TO RESTART OR X TO EXIT", 0
strScoreSaved BYTE "SCORE SAVED!", 0
strThankYou BYTE "THANK YOU FOR PLAYING!", 0
strPaused BYTE "GAME PAUSED", 0
strPauseInstruction BYTE "PRESS ESC TO RESUME OR X TO EXIT", 0
strBossWarning BYTE "*** BOSS BATTLE ***", 0
strBossPhase2 BYTE "BOSS ENRAGED!", 0
strLevelSelect BYTE "SELECT LEVEL (1-2):", 0
strInvalidLevel BYTE "INVALID LEVEL! PRESS ANY KEY...", 0
strNoScores BYTE "NO HIGH SCORES YET. PLAY A GAME!", 0
strHighscoreTitle BYTE "*** HIGH SCORES ***", 0
strHighestScore BYTE "HIGHEST SCORE: ", 0
strHighestScorerName BYTE "PLAYER: ", 0
ground BYTE "------------------------------------------------------------------------------------------------------------------------", 0



scoreFileName BYTE "scores.txt", 0
fileHandle DWORD ?
scoreBuffer BYTE 200 DUP(0)
existingScores BYTE 1000 DUP(0)
existingScoresLen DWORD 0
highestScoreName BYTE 50 DUP(0)

; Add to DATA section after other declarations
flagX BYTE 115
flagY BYTE GROUND_LEVEL - 10
flagActive BYTE 0
flagStr BYTE "|", 0

; Add to LEVEL 1 SCREEN 2 DATA section
flagX_L1_S2 BYTE 115
flagY_L1_S2 BYTE GROUND_LEVEL - 10


strNameLabel BYTE "Name: ",0
strScoreLabel BYTE ", Score: ",0  
strLevelLabel BYTE ", Level: ",0
strSaveError BYTE "ERROR SAVING SCORE!",0

.code

main PROC
call Randomize

mainMenu :
call ShowWelcomeMenu
call GetPlayerName
call SelectLevel
call DrawTitleScreen
mov score, 0
mov coins, 0
mov lives, 3
mov timeLeft, 400
mov gameActive, 1

gameMainLoop:
mov al, level
cmp al, 2
je clearBlack
call Clrscr  ; Normal clear
jmp afterClear
clearBlack:
mov eax, white + (black * 16)
call SetTextColor
call Clrscr
afterClear:
call Clrscr

; Set background color based on level
mov al, level
cmp al, 1
je setLevel1Background
cmp al, 2
je setBossBackground
mov eax, DEFAULT_ATTR
jmp setColorDone
setLevel1Background:
mov eax, LEVEL1_ATTR
jmp setColorDone
setBossBackground :
mov eax, white+(black*16)
setColorDone :
call SetTextColor

call HandleInput
call UpdatePhysics
call UpdateGame

call DrawUI
call DrawClouds
call DrawLevel
call DrawPlayer
call DrawEnemies
call DrawBoss
call DrawProjectiles
call DrawPowerUps
call DrawCoins
call DrawFlag
call CheckFlagCollision

mov eax, 50
call Delay

cmp gameActive, 1
je gameMainLoop

call SaveScoreToFile
call ShowGameOver
cmp gameActive, 1
je mainMenu
jmp exitGame

call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strThankYou
call WriteString
mov dl, 45
mov dh, 14
call Gotoxy
mov edx, OFFSET strScoreSaved
call WriteString
mov eax, 2000
call Delay

exitGame:
exit
main ENDP

ShowWelcomeMenu PROC
push eax
push edx

menuLoop :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 42
mov dh, 8
call Gotoxy
mov edx, OFFSET strWelcome
call WriteString

mov dl, 52
mov dh, 12
call Gotoxy
mov edx, OFFSET strMenuStart
call WriteString

mov dl, 52
mov dh, 14
call Gotoxy
mov edx, OFFSET strMenuHighscore
call WriteString

mov dl, 52
mov dh, 16
call Gotoxy
mov edx, OFFSET strMenuExit
call WriteString

mov dl, 45
mov dh, 20
call Gotoxy
mov edx, OFFSET strEnterChoice
call WriteString

call ReadChar

cmp al, '1'
je startGame
cmp al, '2'
je showHighscore
cmp al, '3'
je exitProgram

mov dl, 42
mov dh, 22
call Gotoxy
mov edx, OFFSET strInvalidChoice
call WriteString
call ReadChar
jmp menuLoop

showHighscore :
call ShowHighscore
jmp menuLoop

startGame :
pop edx
pop eax
ret

exitProgram :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strThankYou
call WriteString
mov eax, 2000
call Delay
exit
ShowWelcomeMenu ENDP

ShowHighscore PROC
    pushad
    
    call Clrscr
    mov eax, DEFAULT_ATTR
    call SetTextColor

    mov dl, 48
    mov dh, 8
    call Gotoxy
    mov edx, OFFSET strHighscoreTitle
    call WriteString
    
    ; Try to open and display the scores file
    mov edx, OFFSET scoreFileName
    call OpenInputFile
    mov fileHandle, eax
    
    cmp eax, INVALID_HANDLE_VALUE
    je noScores
    
    ; Read the entire file
    mov edx, OFFSET existingScores
    mov ecx, SIZEOF existingScores - 1
    call ReadFromFile
    mov existingScoresLen, eax
    
    mov eax, fileHandle
    call CloseFile
    
    cmp existingScoresLen, 0
    je noScores
    
    ; Display all scores
    mov dl, 10
    mov dh, 10
    call Gotoxy
    
    mov edx, OFFSET existingScores
    call WriteString
    
    jmp endProc

noScores:
    mov dl, 42
    mov dh, 12
    call Gotoxy
    mov edx, OFFSET strNoScores
    call WriteString

endProc:
    mov dl, 42
    mov dh, 20
    call Gotoxy
    mov edx, OFFSET strPressAnyKey
    call WriteString
    call ReadChar
    
    popad
    ret
ShowHighscore ENDP
GetPlayerName PROC
push eax
push ecx
push edx

call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strEnterName
call WriteString

mov edx, OFFSET playerName
mov ecx, 49
call ReadString
mov nameLength, al

pop edx
pop ecx
pop eax
ret
GetPlayerName ENDP

SelectLevel PROC
push eax
push ecx
push edx

selectLevelLoop :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 10
call Gotoxy
mov edx, OFFSET strLevelSelect
call WriteString

mov dl, 50
mov dh, 12
call Gotoxy
mov al, '1'
call WriteChar
mov dl, 53
call Gotoxy
mov edx, OFFSET strMenuStart
call WriteString

mov dl, 50
mov dh, 14
call Gotoxy
mov al, '2'
call WriteChar
mov dl, 53
call Gotoxy
mov al, '-'
call WriteChar
mov al, ' '
call WriteChar
mov edx, OFFSET strBossWarning
call WriteString

call ReadChar

cmp al, '1'
je setLevel1
cmp al, '2'
je setLevel2

mov dl, 42
mov dh, 22
call Gotoxy
mov edx, OFFSET strInvalidLevel
call WriteString
call ReadChar
jmp selectLevelLoop

setLevel1 :
mov level, 1
jmp levelSelected

setLevel2 :
mov level, 2
jmp levelSelected

levelSelected :
    mov al, level
    add al, 30h
    mov worldStr[2], al
    call LoadLevel

    pop edx
    pop ecx
    pop eax
    ret
    SelectLevel ENDP

    SaveScoreToFile PROC
    pushad
    
    ; Check if player name is valid
    cmp nameLength, 0
    je saveError
    
    ; First, try to read existing scores
    mov edx, OFFSET scoreFileName
    call OpenInputFile
    mov fileHandle, eax
    
    cmp eax, INVALID_HANDLE_VALUE
    je createNewFile
    
    ; Read existing scores
    mov edx, OFFSET existingScores
    mov ecx, SIZEOF existingScores - 1
    call ReadFromFile
    mov existingScoresLen, eax
    
    mov eax, fileHandle
    call CloseFile
    jmp buildNewEntry

createNewFile:
    ; No existing file, so existingScoresLen = 0
    mov existingScoresLen, 0

buildNewEntry:
    ; Build the new score entry in scoreBuffer
    mov edi, OFFSET scoreBuffer
    
    ; Write "Name: "
    mov esi, OFFSET strNameLabel
    mov ecx, 6
    rep movsb
    
    ; Write player name
    mov esi, OFFSET playerName
    movzx ecx, nameLength
    rep movsb
    
    ; Write ", Score: "
    mov esi, OFFSET strScoreLabel
    mov ecx, 9
    rep movsb
    
    ; Convert and write score
    mov eax, score
    call ConvertNumberToString
    
    ; Write ", Level: "
    mov esi, OFFSET strLevelLabel
    mov ecx, 9
    rep movsb
    
    ; Write level number
    movzx eax, level
    add al, '0'
    stosb
    
    ; Add newline at end of new entry
    mov al, 0Dh    ; Carriage return
    stosb
    mov al, 0Ah    ; Line feed
    stosb
    
    ; Calculate length of new entry
    mov ebx, edi
    sub ebx, OFFSET scoreBuffer
    
    ; Open file for writing (this will overwrite/create the file)
    mov edx, OFFSET scoreFileName
    call CreateOutputFile
    mov fileHandle, eax
    cmp eax, INVALID_HANDLE_VALUE
    je saveError
    
    ; If there were existing scores, write them first
    cmp existingScoresLen, 0
    je writeNewEntryOnly
    
    mov edx, OFFSET existingScores
    mov ecx, existingScoresLen
    call WriteToFile

writeNewEntryOnly:
    ; Write the new score entry
    mov edx, OFFSET scoreBuffer
    mov ecx, ebx
    call WriteToFile
    
    mov eax, fileHandle
    call CloseFile
    
    ; Show success message
    mov dl, 45
    mov dh, 22
    call Gotoxy
    mov edx, OFFSET strScoreSaved
    call WriteString
    mov eax, 1000
    call Delay
    
    jmp saveDone

saveError:
    ; Handle error (could show error message here)
    mov dl, 45
    mov dh, 22
    call Gotoxy
    mov edx, OFFSET strSaveError
    call WriteString

saveDone:
    popad
    ret

SaveScoreToFile ENDP

; Helper procedure to convert number to string
ConvertNumberToString PROC
    ; Input: EAX = number to convert
    ;        EDI = destination buffer
    pushad
    
    mov ebx, 10
    xor ecx, ecx
    
    ; Handle zero case
    test eax, eax
    jnz convertLoop
    mov al, '0'
    stosb
    jmp convertDone
    
convertLoop:
    xor edx, edx
    div ebx
    push edx
    inc ecx
    test eax, eax
    jnz convertLoop
    
writeLoop:
    pop eax
    add al, '0'
    stosb
    loop writeLoop

convertDone:
    popad
    ret
ConvertNumberToString ENDP

DrawTitleScreen PROC
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 50
mov dh, 5
call Gotoxy
mov edx, OFFSET strTitle
call WriteString
mov dl, 0
mov dh, GROUND_LEVEL + 2
call Gotoxy
mov edx, OFFSET ground
call WriteString
mov dl, 55
mov dh, GROUND_LEVEL
call Gotoxy
mov eax, BLUE_MARIO
call SetTextColor
mov al, 'M'
call WriteChar
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 20
call Gotoxy
mov edx, OFFSET strPressAnyKey
call WriteString
call ReadChar
ret
DrawTitleScreen ENDP

DrawUI PROC
mov al, level
cmp al, 2
je setBossUIColor
mov eax, DEFAULT_ATTR
jmp setUIColorDone
setBossUIColor :
mov eax, white + (black * 16)
setUIColorDone :
call SetTextColor

mov dl, 5
mov dh, 1
call Gotoxy
mov edx, OFFSET strScore
call WriteString
mov dl, 5
mov dh, 2
call Gotoxy
mov eax, score
call WriteDec
mov dl, 20
mov dh, 1
call Gotoxy
mov edx, OFFSET strCoins
call WriteString
mov dl, 20
mov dh, 2
call Gotoxy
movzx eax, coins
call WriteDec
mov dl, 35
mov dh, 1
call Gotoxy
mov edx, OFFSET strWorld
call WriteString
mov dl, 35
mov dh, 2
call Gotoxy
mov edx, OFFSET worldStr
call WriteString
mov dl, 50
mov dh, 1
call Gotoxy
mov edx, OFFSET strTime
call WriteString
mov dl, 50
mov dh, 2
call Gotoxy
mov eax, timeLeft
call WriteDec
mov dl, 65
mov dh, 1
call Gotoxy
mov edx, OFFSET strLife
call WriteString
mov dl, 65
mov dh, 2
call Gotoxy
movzx eax, lives
call WriteDec

mov al, level
cmp al, 2
jne skipBossHP
cmp bossActive, 1
jne skipBossHP
mov dl, 80
mov dh, 1
call Gotoxy
mov edx, OFFSET strBossHealth
call WriteString
mov dl, 89
mov dh, 2
call Gotoxy
movzx eax, bossHealth
call WriteDec
skipBossHP :

mov dl, 0
mov dh, GROUND_LEVEL
call Gotoxy
mov edx, OFFSET ground
call WriteString
ret
DrawUI ENDP

DrawClouds PROC
mov ecx, cloudCount
mov esi, 0
cloudLoop:
test ecx, ecx
jz cloudsDone
mov dl, cloudX[esi]
mov dh, cloudY[esi]
call Gotoxy
mov edx, OFFSET cloudStr
call WriteString
inc esi
dec ecx
jmp cloudLoop
cloudsDone :
ret
DrawClouds ENDP

DrawLevel PROC
xor edi, edi
plLoop:
cmp edi, platformCount
jge plDone
mov dl, platformX[edi]
mov dh, platformY[edi]
call Gotoxy
movzx ecx, platformWidth[edi]
mov al, level
cmp al, 1
je drawLevel1Platform
jmp drawDefaultPlatform

drawLevel1Platform:
mov eax, BRICK_ATTR
call SetTextColor
mov al, 205
plInner:
call WriteChar
loop plInner
mov eax, LEVEL1_ATTR
call SetTextColor
jmp nextPlatform

drawDefaultPlatform:
mov al, '='
plInner2:
call WriteChar
loop plInner2
nextPlatform:
inc edi
jmp plLoop
plDone :

mov ecx, wallCount
xor esi, esi
wallLoop:
test ecx, ecx
jz wallsDone
mov al, wallYBottom[esi]
sub al, wallYTop[esi]
inc al
mov bl, wallYTop[esi]
push ecx
movzx ecx, al
mov al, level
cmp al, 1
je drawLevel1Wall
jmp drawDefaultWall

drawLevel1Wall:
mov eax, PIPE_ATTR
call SetTextColor
wallDrawVert:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, 186
call WriteChar
inc bl
loop wallDrawVert
mov eax, LEVEL1_ATTR
call SetTextColor
jmp nextWall

drawDefaultWall:
wallDrawVert2:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, '#'
call WriteChar
inc bl
loop wallDrawVert2
nextWall:
pop ecx
inc esi
dec ecx
jmp wallLoop
wallsDone :
; Reset text color to default for level 1
mov eax, LEVEL1_ATTR
call SetTextColor
ret
DrawLevel ENDP

DrawPlayer PROC
mov dl, marioX
mov dh, marioY
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1Mario
jmp drawDefaultMario

drawLevel1Mario:
mov eax, red + (lightBlue * 16)
call SetTextColor
jmp drawMario

drawDefaultMario:
mov eax, BLUE_MARIO
call SetTextColor

drawMario:
mov al, 'M'
cmp hasSpringPower, 1
jne normalP
mov al, 'S'
normalP:
call WriteChar
mov al, level
cmp al, 1
je resetLevel1Color
jmp resetNormalColor

resetLevel1Color:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp drawPlayerDone

resetNormalColor:
mov eax, DEFAULT_ATTR
call SetTextColor
drawPlayerDone:
ret
DrawPlayer ENDP

DrawEnemies PROC
cmp goomba1Active, 1
jne skipG
mov dl, goomba1X
mov dh, goomba1Y
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1Enemy
jmp drawDefaultEnemy

drawLevel1Enemy:
mov eax, brown + (lightBlue * 16)
call SetTextColor
jmp drawEnemy

drawDefaultEnemy:
mov eax, DEFAULT_ATTR
call SetTextColor

drawEnemy:
mov al, 'G'
call WriteChar
mov al, level
cmp al, 1
je resetLevel1EnemyColor
jmp resetNormalEnemyColor

resetLevel1EnemyColor:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp skipG

resetNormalEnemyColor:
mov eax, DEFAULT_ATTR
call SetTextColor
skipG:
; Draw Koopa Troopa
cmp koopaActive, 1
jne skipKoopa
mov dl, koopaX
mov dh, koopaY
call Gotoxy

cmp koopaShell, 1
je drawShell

; Draw normal Koopa
mov al, level
cmp al, 1
je drawLevel1Koopa
; Add other level colors as needed
jmp drawDefaultKoopa

drawLevel1Koopa:
mov eax, green + (lightBlue * 16)
call SetTextColor
jmp drawKoopaChar

drawDefaultKoopa:
mov eax, green + (black * 16)
call SetTextColor

drawKoopaChar:
mov al, 'K'
call WriteChar
jmp resetKoopaColor

drawShell:
mov eax, DARKGRAY_ATTR
call SetTextColor
mov al, 'S'
call WriteChar

resetKoopaColor:
mov al, level
cmp al, 1
je resetLevel1KoopaColor
mov eax, DEFAULT_ATTR
call SetTextColor
jmp skipKoopa

resetLevel1KoopaColor:
mov eax, LEVEL1_ATTR
call SetTextColor

skipKoopa:
ret
DrawEnemies ENDP

DrawPowerUps PROC
cmp springActive, 1
jne skipSpr
mov dl, springMushroomX
mov dh, springMushroomY
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1PowerUp
jmp drawDefaultPowerUp

drawLevel1PowerUp:
mov eax, green + (lightBlue * 16)
call SetTextColor
jmp drawPowerUp

drawDefaultPowerUp:
mov eax, green + (black * 16)
call SetTextColor

drawPowerUp:
mov al, '!'
call WriteChar
mov al, level
cmp al, 1
je resetLevel1PowerUpColor
jmp resetNormalPowerUpColor

resetLevel1PowerUpColor:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp skipSpr

resetNormalPowerUpColor:
mov eax, DEFAULT_ATTR
call SetTextColor
skipSpr:
ret
DrawPowerUps ENDP

DrawCoins PROC
mov ecx, coinCount
xor esi, esi
coinLoop:
test ecx, ecx
jz coinDone
cmp coinActive[esi], 1
jne coinSkip
mov dl, coinX[esi]
mov dh, coinY[esi]
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1Coin
jmp drawDefaultCoin

drawLevel1Coin:
mov eax, yellow + (lightBlue * 16)
call SetTextColor
jmp drawCoin

drawDefaultCoin:
mov eax, yellow + (blue * 16)
call SetTextColor

drawCoin:
mov al, 'O'
call WriteChar
mov al, level
cmp al, 1
je resetLevel1CoinColor
jmp resetNormalCoinColor

resetLevel1CoinColor:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp coinSkip

resetNormalCoinColor:
mov eax, DEFAULT_ATTR
call SetTextColor
coinSkip:
inc esi
dec ecx
jmp coinLoop
coinDone:
ret
DrawCoins ENDP

UpdatePhysics PROC
cmp isJumping, 0
je notFalling
mov al, marioVelocityY
add al, GRAVITY
cmp al, 10
jle velOk
mov al, 10
velOk:
mov marioVelocityY, al
notFalling :

cmp isJumping, 0
je noVerticalMove
movsx ax, marioVelocityY
movsx bx, marioY
add bx, ax
cmp bx, 0
jge yNotNeg
xor bx, bx
yNotNeg :
cmp bx, GROUND_LEVEL + 5
jle yNotOver
mov bx, GROUND_LEVEL
yNotOver :
mov marioY, bl
noVerticalMove :

call CheckWallCollision
call CheckPlatformLanding

mov al, marioY
cmp al, GROUND_LEVEL
jb notOnFloor
mov marioY, GROUND_LEVEL
mov isJumping, 0
mov marioVelocityY, 0
mov jumpCount, 0
mov canDoubleJump, 1
notOnFloor:

; Check for screen scrolling(only for levels 1)
mov al, level
cmp al, 2
jge skipScreenScrolling

; Check if Mario reached the right edge
cmp marioX, SCREEN_WIDTH - 3
jl checkLeftEdge
call ScrollToNextScreen
jmp skipScreenScrolling

checkLeftEdge :
; Check if Mario reached the left edge
cmp marioX, 2
jg skipScreenScrolling
call ScrollToPreviousScreen

skipScreenScrolling :

cmp marioX, 2
jg xOk1
mov marioX, 2
xOk1 :
    cmp marioX, SCREEN_WIDTH - 3
    jl xOk2
    mov marioX, SCREEN_WIDTH - 3
    xOk2 :
    ret
    UpdatePhysics ENDP

    CheckPlatformLanding PROC
    pushad

    mov ecx, platformCount
    xor esi, esi
    xor dl, dl

    platLoop :
test ecx, ecx
jz checkGroundFall

mov al, marioX
mov bl, platformX[esi]
dec bl
cmp al, bl
jb nextPlat
mov bl, platformX[esi]
add bl, platformWidth[esi]
inc bl
cmp al, bl
jae nextPlat

mov al, marioY
mov bl, platformY[esi]
cmp al, bl
je onPlatform
inc bl
cmp al, bl
jne nextPlat

onPlatform :
mov al, platformY[esi]
mov marioY, al
mov isJumping, 0
mov marioVelocityY, 0
mov jumpCount, 0
mov canDoubleJump, 1
mov dl, 1
jmp platDone

nextPlat :
inc esi
dec ecx
jmp platLoop

checkGroundFall :
test dl, dl
jnz platDone

mov al, marioY
cmp al, GROUND_LEVEL
jae platDone

cmp isJumping, 0
jne platDone

cmp marioVelocityY, 0
jl platDone

mov isJumping, 1
mov marioVelocityY, 0

platDone:
popad
ret
CheckPlatformLanding ENDP

CheckWallCollision PROC
pushad

mov ecx, wallCount
xor esi, esi
wallLoop2 :
test ecx, ecx
jz wallDone2

mov al, marioX
mov bl, wallX[esi]

cmp al, bl
je hitWall
mov dl, bl
dec dl
cmp al, dl
jne nextWall

hitWall :
mov al, marioY
mov bl, wallYTop[esi]
cmp al, bl
jb nextWall
mov bl, wallYBottom[esi]
cmp al, bl
ja nextWall

mov al, wallX[esi]
sub al, 2
mov marioX, al
jmp wallDone2

nextWall :
inc esi
dec ecx
jmp wallLoop2
wallDone2 :
popad
ret
CheckWallCollision ENDP

UpdateGame PROC
call UpdateEnemies
call UpdateBoss
call UpdateProjectiles
call CheckCollisions
call CheckLevelComplete

inc timerCounter
cmp timerCounter, 10
jl timerSkip
mov timerCounter, 0
dec timeLeft
cmp timeLeft, 0
jg timerSkip
call PlayerDie
timerSkip :

cmp hasSpringPower, 1
jne noSpring
dec springTimer
cmp springTimer, 0
jg noSpring
mov hasSpringPower, 0
noSpring:
ret
UpdateGame ENDP

UpdateBoss PROC
pushad

cmp bossActive, 0
je bossUpdateDone

cmp bossStunTimer, 0
je notStunned
dec bossStunTimer
cmp bossStunTimer, 0
jne bossUpdateDone
mov bossVulnerable, 0
jmp bossUpdateDone

notStunned :
mov al, bossDir
add bossX, al
cmp bossX, 70
jle bossDirChange
cmp bossX, 115
jge bossDirChange
jmp bossAttackLogic

bossDirChange :
mov al, bossDir
neg al
mov bossDir, al

bossAttackLogic :
cmp bossAttackTimer, 0
je canAttack
dec bossAttackTimer
jmp bossUpdateDone

canAttack :
call BossFireProjectile
mov al, bossAttackCooldown
cmp bossHealth, 3
jg normalSpeed
shr al, 1
normalSpeed :
    mov bossAttackTimer, al

    bossUpdateDone :
popad
ret
UpdateBoss ENDP

BossFireProjectile PROC
pushad

mov ecx, projectileCount
xor esi, esi
findFreeProj :
cmp ecx, 0
je noFreeProj
cmp projectileActive[esi], 0
je foundFree
inc esi
dec ecx
jmp findFreeProj

foundFree :
mov al, bossX
mov projectileX[esi], al
mov al, bossY
sub al, 2
mov projectileY[esi], al
mov projectileActive[esi], 1
mov al, -2
mov projectileDir[esi], al

noFreeProj :
popad
ret
BossFireProjectile ENDP

UpdateProjectiles PROC
pushad

mov ecx, projectileCount
xor esi, esi
projLoop :
cmp ecx, 0
je projDone
cmp projectileActive[esi], 0
je projSkip

mov al, projectileDir[esi]
add projectileX[esi], al

mov al, projectileX[esi]
cmp al, 2
jl deactivateProj
cmp al, SCREEN_WIDTH - 3
jg deactivateProj
jmp projSkip

deactivateProj :
mov projectileActive[esi], 0

projSkip :
    inc esi
    dec ecx
    jmp projLoop

    projDone :
popad
ret
UpdateProjectiles ENDP

UpdateEnemies PROC
    ; Update Goomba
    cmp goomba1Active, 1
    jne checkKoopaUpdate
    mov al, goomba1Dir
    add goomba1X, al
    cmp goomba1X, 20
    jle eDir
    cmp goomba1X, 90
    jge eDir
    jmp checkKoopaUpdate
eDir:
    mov al, goomba1Dir
    neg al
    mov goomba1Dir, al

checkKoopaUpdate:
    ; Update Koopa Troopa
    cmp koopaActive, 1
    jne updEnemiesEnd
    
    cmp koopaShell, 1
    je shellMode

    ; Normal Koopa movement
    mov al, koopaDir
    add koopaX, al
    cmp koopaX, 20
    jle kDirChange
    cmp koopaX, 90
    jge kDirChange
    jmp updEnemiesEnd

kDirChange:
    mov al, koopaDir
    neg al
    mov koopaDir, al
    jmp updEnemiesEnd

shellMode:
    ; Moving shell - keep moving in current direction
    mov al, koopaDir
    add koopaX, al
    
    ; Check shell boundaries and deactivate if out of bounds
    cmp koopaX, 2
    jl deactivateShell
    cmp koopaX, SCREEN_WIDTH - 3
    jg deactivateShell
    
    ; Check for collisions with other enemies while shell is moving
    call CheckShellEnemyCollisions
    jmp updEnemiesEnd

deactivateShell:
    mov koopaActive, 0

updEnemiesEnd:
    ret
UpdateEnemies ENDP

CheckCollisions PROC
call CheckCoinCollisions
call CheckPowerUpCollisions
call CheckEnemyCollisions
call CheckBossCollisions
call CheckProjectileCollisions
ret
CheckCollisions ENDP

CheckCoinCollisions PROC
pushad

mov ecx, coinCount
xor esi, esi
ccLoop :
test ecx, ecx
jz ccDone
cmp coinActive[esi], 1
jne ccSkip

mov al, marioX
mov bl, coinX[esi]
sub al, bl
cmp al, 0
jge xPosDiff
neg al
xPosDiff :
cmp al, 1
jg ccSkip

mov al, marioY
mov bl, coinY[esi]
sub al, bl
cmp al, 0
jge yPosDiff
neg al
yPosDiff :
cmp al, 1
jg ccSkip

mov coinActive[esi], 0
inc coins
add score, 200
call PlayCoinSound

ccSkip :
inc esi
dec ecx
jmp ccLoop
ccDone :
popad
ret
CheckCoinCollisions ENDP

CheckPowerUpCollisions PROC
pushad

cmp springActive, 1
jne pSkip

mov al, marioX
mov bl, springMushroomX
sub al, bl
cmp al, 0
jge xPosDiff2
neg al
xPosDiff2 :
cmp al, 2
jg pSkip

mov al, marioY
mov bl, springMushroomY
sub al, bl
cmp al, 0
jge yPosDiff2
neg al
yPosDiff2 :
cmp al, 2
jg pSkip

mov springActive, 0
mov hasSpringPower, 1
mov springTimer, 100
add score, 1000
call PlayPowerUpSound
pSkip :
popad
ret
CheckPowerUpCollisions ENDP

CheckShellEnemyCollisions PROC
    pushad
    
    ; Check collision with Goomba
    cmp goomba1Active, 1
    jne shellCollisionDone
    
    mov al, koopaX
    mov bl, goomba1X
    sub al, bl
    cmp al, 0
    jge shellXPosDiff
    neg al
shellXPosDiff:
    cmp al, 1
    jg shellCollisionDone
    
    mov al, koopaY
    mov bl, goomba1Y
    sub al, bl
    cmp al, 0
    jge shellYPosDiff
    neg al
shellYPosDiff:
    cmp al, 1
    jg shellCollisionDone
    
    ; Shell hit Goomba - kill Goomba and deactivate shell
    mov goomba1Active, 0
    mov koopaActive, 0
    add score, 200  ; Bonus for killing Goomba with shell
    call PlayCoinSound

shellCollisionDone:
    popad
    ret
CheckShellEnemyCollisions ENDP

CheckEnemyCollisions PROC
    pushad

    ; Check Goomba collision
    cmp goomba1Active, 1
    jne checkKoopa

    mov al, marioX
    mov bl, goomba1X
    sub al, bl
    cmp al, 0
    jge xPosDiffGoomba
    neg al
xPosDiffGoomba:
    cmp al, 1
    jg checkKoopa

    mov al, marioY
    mov bl, goomba1Y
    sub al, bl
    cmp al, 0
    jge yPosDiffGoomba
    neg al
yPosDiffGoomba:
    cmp al, 1
    jg checkKoopa

    call PlayerDie
    jmp enemyCollisionsDone

checkKoopa:
    ; Koopa Troopa collision
    cmp koopaActive, 1
    jne enemyCollisionsDone

    mov al, marioX
    mov bl, koopaX
    sub al, bl
    cmp al, 0
    jge xPosDiffKoopa
    neg al
xPosDiffKoopa:
    cmp al, 1
    jg enemyCollisionsDone

    mov al, marioY
    mov bl, koopaY
    sub al, bl
    cmp al, 0
    jge yPosDiffKoopa
    neg al
yPosDiffKoopa:
    cmp al, 1
    jg enemyCollisionsDone

    cmp koopaShell, 1
    je hitShell

    ; Jumped on Koopa (normal state)
    cmp marioVelocityY, 0
    jl enemyCollisionsDone  ; Only activate if falling onto Koopa

    ; Mario jumped on Koopa - turn into moving shell
    mov koopaShell, 1
    mov shellTimer, 100  ; Shell stays for 100 frames
    
    ; Determine shell direction based on Mario's position
    mov al, marioX
    cmp al, koopaX
    jl marioLeftOfKoopaJump
    ; Mario right of Koopa - shell goes left
    mov koopaDir, -2  ; Faster movement for active shell
    jmp koopaJumpComplete
marioLeftOfKoopaJump:
    ; Mario left of Koopa - shell goes right  
    mov koopaDir, 2   ; Faster movement for active shell
    
koopaJumpComplete:
    add score, 500

    ; Bounce Mario
    mov al, JUMP_STRENGTH
    neg al
    mov marioVelocityY, al
    mov isJumping, 1
    jmp enemyCollisionsDone

hitShell:
    ; Mario hits moving shell from side
    cmp koopaDir, 0
    je stationaryShell  ; If shell is stationary, don't damage Mario
    
    cmp koopaDir, 2
    je movingShell
    cmp koopaDir, -2
    je movingShell
    jmp stationaryShell

    movingShell:
    mov al, marioX
    cmp al, koopaX
    jl marioLeftOfKoopa
    ; Mario right of Koopa
    mov koopaDir, -2  ; Shell goes left
    jmp koopaDamages

marioLeftOfKoopa:
    mov koopaDir, 2   ; Shell goes right

koopaDamages:
    call PlayerDie
    jmp enemyCollisionsDone

stationaryShell:
    ; Mario hits stationary shell - kick it
    mov al, marioX
    cmp al, koopaX
    jl marioLeftOfStationary
    ; Mario right of shell - kick left
    mov koopaDir, -2
    jmp enemyCollisionsDone
marioLeftOfStationary:
    ; Mario left of shell - kick right
    mov koopaDir, 2

enemyCollisionsDone:
    popad
    ret
CheckEnemyCollisions ENDP

CheckFlagCollision PROC
    pushad
    
    cmp flagActive, 1
    jne flagCollisionDone
    
    ; Check if Mario is close to the flag
    mov al, marioX
    mov bl, flagX
    sub al, bl
    cmp al, 0
    jge flagXPosDiff
    neg al
flagXPosDiff:
    cmp al, 2  ; Increased range for flag collision
    jg flagCollisionDone
    
    mov al, marioY
    mov bl, flagY
    sub al, bl
    cmp al, 0
    jge flagYPosDiff
    neg al
flagYPosDiff:
    cmp al, 10  ; Check entire flag pole height
    jg flagCollisionDone
    
    ; Flag collision detected - complete level
    call ShowLevelComplete
    
flagCollisionDone:
    popad
    ret
CheckFlagCollision ENDP

CheckBossCollisions PROC
pushad

cmp bossActive, 0
je bossColDone

mov al, marioX
mov bl, bossX
sub al, bl
cmp al, 0
jge xPosDiffBoss
neg al
xPosDiffBoss :
cmp al, 3
jg bossColDone

mov al, marioY
mov bl, bossY
sub al, bl
cmp al, 0
jge yPosDiffBoss
neg al
yPosDiffBoss :

cmp al, 2
je jumpedOnBoss
cmp al, 3
je jumpedOnBoss

cmp al, 1
jle bossDamagesMario
jmp bossColDone

jumpedOnBoss :
cmp marioVelocityY, 0
jl bossColDone

mov bossVulnerable, 1
mov bossStunTimer, 20
dec bossHealth
add score, 1000

mov al, JUMP_STRENGTH
neg al
mov marioVelocityY, al
mov isJumping, 1

cmp bossHealth, 3
jne checkDefeat
call ShowPhase2Warning

checkDefeat :
cmp bossHealth, 0
jle bossDefeated

jmp bossColDone

bossDefeated:
call ShowBossDefeated
jmp bossColDone

bossDamagesMario :
cmp bossStunTimer, 0
jg bossColDone
call PlayerDie

bossColDone :
popad
ret
CheckBossCollisions ENDP

CheckProjectileCollisions PROC
pushad

mov ecx, projectileCount
xor esi, esi
projColLoop :
cmp ecx, 0
je projColDone
cmp projectileActive[esi], 0
je projColSkip

mov al, marioX
mov bl, projectileX[esi]
sub al, bl
cmp al, 0
jge xPosDiffProj
neg al
xPosDiffProj :
cmp al, 1
jg projColSkip

mov al, marioY
mov bl, projectileY[esi]
sub al, bl
cmp al, 0
jge yPosDiffProj
neg al
yPosDiffProj :
cmp al, 1
jg projColSkip

mov projectileActive[esi], 0
call PlayerDie
jmp projColDone

projColSkip :
inc esi
dec ecx
jmp projColLoop

projColDone :
popad
ret
CheckProjectileCollisions ENDP

CheckLevelComplete PROC
    pushad

    mov al, level
    cmp al, 2
    je normalLevelCheck  ; Boss level still uses coin collection

    ; For levels 1, only flag completion matters (handled in CheckFlagCollision)
    ; Remove coin-based completion for these levels
    jmp notComplete

normalLevelCheck:
    ; Original coin collection logic for boss level
    xor bl, bl
    mov ecx, coinCount
    xor esi, esi
countLoop:
    test ecx, ecx
    jz checkCount
    mov al, coinActive[esi]
    add bl, al
    inc esi
    dec ecx
    jmp countLoop

checkCount:
    test bl, bl
    jnz notComplete

    call ShowLevelComplete

notComplete:
    completeChecked:
    popad
    ret
CheckLevelComplete ENDP
ShowBossDefeated PROC
call Clrscr
mov eax, BOSS_ATTR
call SetTextColor

mov dl, 48
mov dh, 10
call Gotoxy
mov edx, OFFSET strBossDefeated
call WriteString

mov dl, 45
mov dh, 12
call Gotoxy
mov edx, OFFSET strScore
call WriteString
mov dl, 52
call Gotoxy
mov eax, score
call WriteDec

add score, 5000

mov dl, 45
mov dh, 16
call Gotoxy
mov edx, OFFSET strAllComplete
call WriteString

mov eax, 3000
call Delay
mov gameActive, 0
ret
ShowBossDefeated ENDP

DrawHighscores PROC
pushad

cmp existingScoresLen, 0
je noScores

mov edx, OFFSET existingScores
mov ecx, existingScoresLen
call ReadString

mov edx, OFFSET strHighestScore
call WriteString

mov eax, score
call WriteDec

mov edx, OFFSET strNoScores
call WriteString

noScores :
popad
ret
DrawHighscores ENDP

ShowLevelComplete PROC
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 50
mov dh, 12
call Gotoxy
mov edx, OFFSET strLevelComplete
call WriteString

mov dl, 45
mov dh, 14
call Gotoxy
mov edx, OFFSET strScore
call WriteString
mov dl, 52
call Gotoxy
mov eax, score
call WriteDec
add score, 1000

mov al, level
cmp al, 2
jge allLevelsComplete

mov dl, 42
mov dh, 18
call Gotoxy
mov edx, OFFSET strNextLevel
call WriteString

call ReadChar

inc level
mov screenVersion, 1
call LoadLevel
ret

allLevelsComplete :
mov dl, 45
mov dh, 16
call Gotoxy
mov edx, OFFSET strAllComplete
call WriteString

mov eax, 2000
call Delay

; Save score before ending game
call SaveScoreToFile

mov eax, 1000
call Delay
mov gameActive, 0
ret
ShowLevelComplete ENDP

ScrollToNextScreen PROC
pushad

; Only switch to screen 2 if we're on screen 1
cmp screenVersion, 1
jne scrollDone

mov screenVersion, 2
mov marioX, 3

call LoadScreenVersion

scrollDone :
popad
ret
ScrollToNextScreen ENDP

ScrollToPreviousScreen PROC
pushad

; Only switch to screen 2 if we're on screen 1
cmp screenVersion, 2
jne scrollDone2

mov screenVersion, 1
mov marioX, SCREEN_WIDTH - 4

call LoadScreenVersion

scrollDone2 :
popad
ret
ScrollToPreviousScreen ENDP

LoadScreenVersion PROC
pushad

mov al, level
cmp al, 1
je loadL1Screen
jmp loadScreenDone

loadL1Screen :
cmp screenVersion, 1
je loadL1S1
jmp loadL1S2

loadL1S1 :
; Load Level 1 Screen 1 (original data already in place from LoadLevel)
; We need to reload from the base arrays
; For simplicity, call LoadLevel to reset to screen 1
jmp loadScreenDone

loadL1S2 :
; Load Level 1 Screen 2
mov esi, OFFSET coinX_L1_S2
mov edi, OFFSET coinX
mov ecx, coinCount
rep movsb

mov esi, OFFSET coinY_L1_S2
mov edi, OFFSET coinY
mov ecx, coinCount
rep movsb

mov al, goomba1X_L1_S2
mov goomba1X, al
mov al, goomba1Y_L1_S2
mov goomba1Y, al
mov goomba1Active, 1
mov goomba1Dir, 1

mov al, koopaX_L1_S2
mov koopaX, al
mov al, koopaY_L1_S2
mov koopaY, al
mov koopaActive, 1
mov koopaShell, 0
mov koopaDir, -1

mov esi, OFFSET platformX_L1_S2
mov edi, OFFSET platformX
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformY_L1_S2
mov edi, OFFSET platformY
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformWidth_L1_S2
mov edi, OFFSET platformWidth
mov ecx, platformCount
rep movsb

mov esi, OFFSET wallX_L1_S2
mov edi, OFFSET wallX
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYTop_L1_S2
mov edi, OFFSET wallYTop
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYBottom_L1_S2
mov edi, OFFSET wallYBottom
mov ecx, wallCount
rep movsb

mov al, springMushroomX_L1_S2
mov springMushroomX, al
mov al, springMushroomY_L1_S2
mov springMushroomY, al

mov al, flagX_L1_S2
mov flagX, al
mov al, flagY_L1_S2  
mov flagY, al
mov flagActive, 1

jmp resetCoinsScreen

resetCoinsScreen :
; Reset coin active status
mov ecx, coinCount
xor esi, esi
resetCoinLoopScreen :
test ecx, ecx
jz loadScreenDone
mov coinActive[esi], 1
inc esi
dec ecx
jmp resetCoinLoopScreen

coinsResetDone:
mov al, flagX_L1_S2
mov flagX, al
mov al, flagY_L1_S2
mov flagY, al
mov flagActive, 1


loadScreenDone :
popad
ret
LoadScreenVersion ENDP

LoadLevel PROC
pushad
mov flagActive, 0

mov marioX, 10
mov marioY, GROUND_LEVEL
mov isJumping, 0
mov marioVelocityY, 0
mov jumpCount, 0
mov canDoubleJump, 1
mov coins, 0
mov timeLeft, 400
mov timerCounter, 0

mov hasSpringPower, 0
mov springActive, 1

mov al, level
add al, 30h
mov worldStr[2], al

mov al, level
cmp al, 1
je loadLevel1_1
cmp al, 2
je loadLevel2
jmp resetCoins

loadLevel1_1 :
mov flagActive, 0
mov esi, OFFSET coinX
mov edi, OFFSET coinX
mov ecx, coinCount
rep movsb

mov esi, OFFSET coinY
mov edi, OFFSET coinY
mov ecx, coinCount
rep movsb

mov al, goomba1X
mov goomba1X, al
mov al, goomba1Y
mov goomba1Y, al
mov goomba1Active, 1
mov goomba1Dir, 1

mov al, 70
mov koopaX, al
mov al, GROUND_LEVEL
mov koopaY, al
mov koopaActive, 1
mov koopaShell, 0
mov koopaDir, -1

mov esi, OFFSET platformX
mov edi, OFFSET platformX
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformY
mov edi, OFFSET platformY
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformWidth
mov edi, OFFSET platformWidth
mov ecx, platformCount
rep movsb

mov esi, OFFSET wallX
mov edi, OFFSET wallX
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYTop
mov edi, OFFSET wallYTop
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYBottom
mov edi, OFFSET wallYBottom
mov ecx, wallCount
rep movsb

mov bossActive, 0
jmp resetCoins

loadLevel1_2 :
; Load Level 1 Screen 2
mov esi, OFFSET coinX_L1_S2
mov edi, OFFSET coinX
mov ecx, coinCount
rep movsb

mov esi, OFFSET coinY_L1_S2
mov edi, OFFSET coinY
mov ecx, coinCount
rep movsb

mov al, goomba1X_L1_S2
mov goomba1X, al
mov al, goomba1Y_L1_S2
mov goomba1Y, al
mov goomba1Active, 1
mov goomba1Dir, 1

mov esi, OFFSET platformX_L1_S2
mov edi, OFFSET platformX
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformY_L1_S2
mov edi, OFFSET platformY
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformWidth_L1_S2
mov edi, OFFSET platformWidth
mov ecx, platformCount
rep movsb

mov esi, OFFSET wallX_L1_S2
mov edi, OFFSET wallX
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYTop_L1_S2
mov edi, OFFSET wallYTop
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYBottom_L1_S2
mov edi, OFFSET wallYBottom
mov ecx, wallCount
rep movsb

mov al, springMushroomX_L1_S2
mov springMushroomX, al
mov al, springMushroomY_L1_S2
mov springMushroomY, al

jmp resetCoins

loadLevel2 :
mov esi, OFFSET coinX_L4
mov edi, OFFSET coinX
mov ecx, coinCount
rep movsb

mov esi, OFFSET coinY_L4
mov edi, OFFSET coinY
mov ecx, coinCount
rep movsb

mov goomba1Active, 0
mov koopaActive, 0

mov esi, OFFSET platformX_L4
mov edi, OFFSET platformX
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformY_L4
mov edi, OFFSET platformY
mov ecx, platformCount
rep movsb

mov esi, OFFSET platformWidth_L4
mov edi, OFFSET platformWidth
mov ecx, platformCount
rep movsb

mov esi, OFFSET wallX_L4
mov edi, OFFSET wallX
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYTop_L4
mov edi, OFFSET wallYTop
mov ecx, wallCount
rep movsb

mov esi, OFFSET wallYBottom_L4
mov edi, OFFSET wallYBottom
mov ecx, wallCount
rep movsb

mov bossX, 100
mov bossY, GROUND_LEVEL
mov bossHealth, 5
mov bossActive, 1
mov bossDir, -1
mov bossAttackTimer, 30
mov bossAttackCooldown, 30
mov bossVulnerable, 0
mov bossStunTimer, 0
mov bossPhase, 1

push eax
push ecx
push edi
mov edi, OFFSET playerName
mov ecx, 50
xor al, al
rep stosb
mov nameLength, 0
pop edi
pop ecx
pop eax

push eax
push ecx
push esi
mov ecx, projectileCount
xor esi, esi
clearProjLoop :
cmp ecx, 0
je projCleared
mov projectileActive[esi], 0
inc esi
dec ecx
jmp clearProjLoop
projCleared :
pop esi
pop ecx
pop eax

call ShowBossWarning

mov springActive, 0
mov timeLeft, 600
jmp resetCoins

resetCoins :
mov ecx, coinCount
xor esi, esi
resetCoinLoop :
test ecx, ecx
jz loadDone
mov coinActive[esi], 1
inc esi
dec ecx
jmp resetCoinLoop

loadDone :
popad
ret
LoadLevel ENDP

DrawFlag PROC
    pushad
    
    cmp flagActive, 1
    jne flagDrawDone
    
    ; Draw flag pole
    mov dl, flagX
    mov dh, flagY
    call Gotoxy
    
    mov al, level
    cmp al, 1
    je drawLevel1Flag
    jmp drawDefaultFlag

    drawLevel1Flag:
        mov eax, white + (lightBlue * 16)
        call SetTextColor
        jmp drawFlagPole

    drawDefaultFlag:
        mov eax, white + (blue * 16)
        call SetTextColor

    drawFlagPole:
        ; Draw the pole (vertical line)
        mov ecx, 8
        mov dh, flagY
    flagPoleLoop:
        call Gotoxy
        mov al, '|'
        call WriteChar
        inc dh
        loop flagPoleLoop
    
        ; Draw the flag
        mov dl, flagX
        mov dh, flagY
        call Gotoxy
        mov al, 30 ; Triangle character for flag
        call WriteChar
    
        ; Reset color
        mov al, level
        cmp al, 1
        je resetLevel1FlagColor
        mov eax, DEFAULT_ATTR
        jmp flagDrawDone

    resetLevel1FlagColor:
        mov eax, LEVEL1_ATTR
        jmp flagDrawDone

    flagDrawDone:
        call SetTextColor
        popad
        ret
    DrawFlag ENDP

ShowBossWarning PROC
pushad

call Clrscr
mov eax, BOSS_ATTR
call SetTextColor

mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strBossWarning
call WriteString

mov dl, 40
mov dh, 15
call Gotoxy
mov edx, OFFSET strPressAnyKey
call WriteString

call ReadChar

popad
ret
ShowBossWarning ENDP

DrawBoss PROC
pushad

cmp bossActive, 0
je bossDrawDone

mov dl, bossX
mov dh, bossY
call Gotoxy

cmp bossVulnerable, 1
je drawVulnerable
mov eax, red + (black * 16)
call SetTextColor
jmp drawBossChar

drawVulnerable:
mov eax, yellow + (black * 16)
call SetTextColor

drawBossChar:
mov al, 'B'
call WriteChar

mov dl, bossX
inc dl
mov dh, bossY
call Gotoxy
mov al, 'B'
call WriteChar

mov dl, bossX
mov dh, bossY
dec dh
call Gotoxy
mov al, '^'
call WriteChar

mov al, level
cmp al, 2
je setBossTextColor
mov eax, DEFAULT_ATTR
jmp resetColorDone
setBossTextColor:
mov eax, white + (black * 16)
resetColorDone:
call SetTextColor

bossDrawDone:
popad
ret
DrawBoss ENDP

DrawProjectiles PROC
pushad

mov ecx, projectileCount
xor esi, esi
drawProjLoop:
cmp ecx, 0
je drawProjDone
cmp projectileActive[esi], 0
je drawProjSkip

mov dl, projectileX[esi]
mov dh, projectileY[esi]
call Gotoxy
mov eax, red + (black * 16)
call SetTextColor
mov al, '*'
call WriteChar

drawProjSkip:
inc esi
dec ecx
jmp drawProjLoop

drawProjDone:
mov al, level
cmp al, 2
je setBossProjColor
mov eax, DEFAULT_ATTR
jmp resetProjColorDone
setBossProjColor:
mov eax, white + (black * 16)
resetProjColorDone:
call SetTextColor

popad
ret
DrawProjectiles ENDP

ShowPhase2Warning PROC
pushad

push eax
push edx

mov dl, 48
mov dh, 15
call Gotoxy
mov eax, yellow + (red * 16)
call SetTextColor
mov edx, OFFSET strBossPhase2
call WriteString
mov eax, 800
call Delay

pop edx
pop eax

popad
ret
ShowPhase2Warning ENDP

PlayerDie PROC
dec lives
cmp lives, 0
jg respawn

call ShowGameOver
mov gameActive, 0
jmp diedDone

respawn :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strYouDied
call WriteString

mov dl, 50
mov dh, 14
call Gotoxy
mov edx, OFFSET strLife
call WriteString
mov dl, 56
call Gotoxy
movzx eax, lives
call WriteDec

mov eax, 2000
call Delay

mov marioX, 10
mov marioY, GROUND_LEVEL
mov isJumping, 0
mov marioVelocityY, 0
mov jumpCount, 0
mov canDoubleJump, 1

mov al, level
cmp al, 2
je skipKoopaReset
mov koopaActive, 1
mov koopaShell, 0
mov koopaDir, -1
mov koopaX, 70
mov koopaY, GROUND_LEVEL

skipKoopaReset:
diedDone:
ret
PlayerDie ENDP

ShowGameOver PROC
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 52
mov dh, 10
call Gotoxy
mov edx, OFFSET strGameOver
call WriteString

mov dl, 48
mov dh, 13
call Gotoxy
mov edx, OFFSET strScore
call WriteString
mov dl, 55
call Gotoxy
mov eax, score
call WriteDec

mov dl, 48
mov dh, 15
call Gotoxy
mov edx, OFFSET strCoins
call WriteString
mov dl, 55
call Gotoxy
movzx eax, coins
call WriteDec

mov dl, 48
mov dh, 17
call Gotoxy
mov edx, OFFSET strWorld
call WriteString
mov dl, 55
call Gotoxy
mov edx, OFFSET worldStr
call WriteString

mov dl, 42
mov dh, 20
call Gotoxy
mov edx, OFFSET strRestart
call WriteString

waitForInput :
call ReadChar

cmp al, 'R'
je restartGame
cmp al, 'r'
je restartGame

cmp al, 'X'
je exitGame
cmp al, 'x'
je exitGame

jmp waitForInput

restartGame :
mov gameActive, 1
call LoadLevel
jmp gameOverDone

exitGame :
mov gameActive, 0
gameOverDone:
ret
ShowGameOver ENDP

HandleInput PROC
pushad

xor bl, bl
xor bh, bh

inputLoop :
call ReadKey
jz applyMovement

mov bh, al

test al, al
jne checkAscii
cmp ah, 4Bh
je markLeft
cmp ah, 4Dh
je markRight
cmp ah, 48h
je markJump
cmp ah, 1
je checkPause
jmp inputLoop

checkAscii :
mov cl, bh
cmp cl, 'A'
jb asciiReady
cmp cl, 'Z'
ja asciiReady
or cl, 20h
asciiReady :
cmp cl, 'x'
je exitGame
cmp cl, 'a'
je markLeft
cmp cl, 'd'
je markRight
cmp cl, 'w'
je markJump
cmp cl, ' '
je markDoubleJump
cmp cl, 27
je checkPause
jmp inputLoop

checkPause :
call ShowPauseScreen
jmp inputLoop

markLeft :
or bl, 1
jmp inputLoop

markRight :
or bl, 2
jmp inputLoop

markJump :
or bl, 4
jmp inputLoop

markDoubleJump :
or bl, 8
jmp inputLoop

exitGame :
mov gameActive, 0
jmp inputLoop

applyMovement :
test bl, 1
jz noLeft
mov al, marioX
sub al, 2
cmp al, 2
jge leftOk
mov al, 2
leftOk:
mov marioX, al
noLeft :

test bl, 2
jz noRight
mov al, marioX
add al, 2
cmp al, SCREEN_WIDTH - 3
jle rightOk
mov al, SCREEN_WIDTH - 3
rightOk:
mov marioX, al
noRight :

test bl, 4
jz noJump
cmp isJumping, 1
je noJump

mov isJumping, 1
mov jumpCount, 1
mov canDoubleJump, 1

cmp hasSpringPower, 1
jne normalJump
mov al, HIGH_JUMP_STRENGTH
neg al
mov marioVelocityY, al
jmp noJump
normalJump :
mov al, JUMP_STRENGTH
neg al
mov marioVelocityY, al
noJump :

test bl, 8
jz noDoubleJump
cmp isJumping, 1
jne noDoubleJump
cmp canDoubleJump, 1
jne noDoubleJump
cmp jumpCount, 1
jne noDoubleJump

mov canDoubleJump, 0
mov jumpCount, 2
mov al, JUMP_STRENGTH
neg al
mov marioVelocityY, al
noDoubleJump :

popad
ret
HandleInput ENDP

ShowPauseScreen PROC
pushad

mov eax, black + (white * 16)
call SetTextColor

mov dl, 40
mov dh, 10
call Gotoxy
mov edx, OFFSET strPaused
call WriteString

mov dl, 32
mov dh, 12
call Gotoxy
mov edx, OFFSET strPauseInstruction
call WriteString

pauseLoop :
call ReadKey
jz pauseLoop

cmp al, 27
je pauseEnd

cmp ah, 1
je pauseEnd

mov cl, al
cmp cl, 'A'
jb checkX
cmp cl, 'Z'
ja checkX
or cl, 20h
checkX :
cmp cl, 'x'
je exitFromPause

jmp pauseLoop

exitFromPause :
mov gameActive, 0
jmp pauseEnd

pauseEnd :
popad
ret
ShowPauseScreen ENDP

PlayJumpSound PROC
push eax
mov eax, 100
call Delay
pop eax
ret
PlayJumpSound ENDP

PlayDoubleJumpSound PROC
push eax
mov eax, 80
call Delay
mov eax, 120
call Delay
pop eax
ret
PlayDoubleJumpSound ENDP

PlayCoinSound PROC
push eax
mov eax, 50
call Delay
pop eax
ret
PlayCoinSound ENDP

PlayPowerUpSound PROC
push eax
mov eax, 60
call Delay
mov eax, 80
call Delay
mov eax, 100
call Delay
pop eax
ret
PlayPowerUpSound ENDP

END main
