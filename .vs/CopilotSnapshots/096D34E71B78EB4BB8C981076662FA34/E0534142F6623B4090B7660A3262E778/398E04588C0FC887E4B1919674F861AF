INCLUDE Irvine32.inc

.data
SCREEN_WIDTH = 120
SCREEN_HEIGHT = 30
GROUND_LEVEL = 25
GRAVITY = 1
JUMP_STRENGTH = 4
HIGH_JUMP_STRENGTH = 6

DEFAULT_ATTR = white + (blue * 16)
LEVEL1_ATTR = white + (lightBlue * 16)
LEVEL2_ATTR = white + (black * 16)
LEVEL3_ATTR = white + (yellow * 16)
PIPE_ATTR = white + (green * 16)
BRICK_ATTR = white + (brown * 16)
PIPE_ATTR_L2 = white + (green * 16)
BRICK_ATTR_L2 = white + (brown * 16)
PIPE_ATTR_L3 = white + (green * 16)
BRICK_ATTR_L3 = white + (brown * 16)
BOSS_ATTR = white + (red * 16)
BLUE_MARIO = blue + (lightBlue * 16)
KOOPA_ATTR = green + (lightBlue * 16)

gameActive BYTE 1
score DWORD 0
coins BYTE 0
lives BYTE 3
level BYTE 1
screenVersion BYTE 1
timeLeft DWORD 400
worldStr BYTE "1-1", 0
timerCounter BYTE 0

playerName BYTE 50 DUP(0)
nameLength BYTE 0

marioX BYTE 10
marioY BYTE GROUND_LEVEL
marioVelocityY SBYTE 0
isJumping BYTE 0
canDoubleJump BYTE 1
jumpCount BYTE 0
marioState BYTE 0
hasSpringPower BYTE 0
springTimer BYTE 0

springMushroomX BYTE 30
springMushroomY BYTE GROUND_LEVEL - 1
springActive BYTE 1

; KOOPA TROOPA VARIABLES
koopaX BYTE 70
koopaY BYTE GROUND_LEVEL
koopaDir SBYTE -1
koopaActive BYTE 1
koopaIsShell BYTE 0
koopaShellMoving BYTE 0
koopaShellDir SBYTE 0

; BOSS LEVEL 4 VARIABLES
bossX BYTE 100
bossY BYTE GROUND_LEVEL
bossHealth BYTE 5
bossActive BYTE 0
bossDir SBYTE - 1
bossAttackTimer BYTE 0
bossAttackCooldown BYTE 30
bossVulnerable BYTE 0
bossStunTimer BYTE 0
bossPhase BYTE 1

; BOSS PROJECTILES
projectileCount = 3
projectileX BYTE 0, 0, 0
projectileY BYTE 0, 0, 0
projectileActive BYTE 0, 0, 0
projectileDir SBYTE 0, 0, 0

; LEVEL 1 SCREEN 1 DATA
coinCount = 15
coinX BYTE 12, 13, 14, 32, 33, 34, 62, 63, 64, 92, 93, 94, 110, 111, 112
coinY BYTE GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4
coinActive BYTE 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1

goomba1X BYTE 45
goomba1Y BYTE GROUND_LEVEL
goomba1Dir SBYTE 1
goomba1Active BYTE 1

platformCount = 6
platformX BYTE 10, 30, 60, 28, 85, 95
platformY BYTE GROUND_LEVEL - 5, GROUND_LEVEL - 8, GROUND_LEVEL - 4, GROUND_LEVEL - 10, GROUND_LEVEL - 6, GROUND_LEVEL - 12
platformWidth BYTE 10, 10, 8, 7, 9, 5

wallCount = 3
wallX BYTE 25, 55, 80
wallYTop BYTE GROUND_LEVEL - 6, GROUND_LEVEL - 8, GROUND_LEVEL - 5
wallYBottom BYTE GROUND_LEVEL, GROUND_LEVEL - 2, GROUND_LEVEL

; LEVEL 1 SCREEN 2 DATA
coinX_L1_S2 BYTE 8, 9, 10, 25, 26, 27, 50, 51, 52, 75, 76, 77, 98, 99, 100
coinY_L1_S2 BYTE GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5
goomba1X_L1_S2 BYTE 55
goomba1Y_L1_S2 BYTE GROUND_LEVEL
platformX_L1_S2 BYTE 5, 23, 48, 40, 73, 96
platformY_L1_S2 BYTE GROUND_LEVEL - 7, GROUND_LEVEL - 9, GROUND_LEVEL - 5, GROUND_LEVEL - 11, GROUND_LEVEL - 8, GROUND_LEVEL - 10
platformWidth_L1_S2 BYTE 8, 12, 9, 8, 10, 6
wallX_L1_S2 BYTE 18, 63, 88
wallYTop_L1_S2 BYTE GROUND_LEVEL - 7, GROUND_LEVEL - 9, GROUND_LEVEL - 6
wallYBottom_L1_S2 BYTE GROUND_LEVEL, GROUND_LEVEL - 1, GROUND_LEVEL
springMushroomX_L1_S2 BYTE 35
springMushroomY_L1_S2 BYTE GROUND_LEVEL - 1

coinX_L2 BYTE 15, 16, 17, 40, 41, 42, 82, 83, 84, 100, 101, 102, 108, 109, 110
coinY_L2 BYTE GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4
goomba1X_L2 BYTE 45
goomba1Y_L2 BYTE GROUND_LEVEL
platformX_L2 BYTE 12, 38, 78, 22, 88, 98
platformY_L2 BYTE GROUND_LEVEL - 7, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 10, GROUND_LEVEL - 8, GROUND_LEVEL - 11
platformWidth_L2 BYTE 9, 10, 8, 6, 10, 7
wallX_L2 BYTE 30, 60, 75
wallYTop_L2 BYTE GROUND_LEVEL - 8, GROUND_LEVEL - 6, GROUND_LEVEL - 9
wallYBottom_L2 BYTE GROUND_LEVEL, GROUND_LEVEL - 1, GROUND_LEVEL
springMushroomX_L2 BYTE 40
springMushroomY_L2 BYTE GROUND_LEVEL - 1

; LEVEL 2 SCREEN 2 DATA
coinX_L2_S2 BYTE 10, 11, 12, 35, 36, 37, 68, 69, 70, 90, 91, 92, 105, 106, 107
coinY_L2_S2 BYTE GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6
goomba1X_L2_S2 BYTE 50
goomba1Y_L2_S2 BYTE GROUND_LEVEL
platformX_L2_S2 BYTE 8, 33, 66, 18, 84, 100
platformY_L2_S2 BYTE GROUND_LEVEL - 9, GROUND_LEVEL - 5, GROUND_LEVEL - 7, GROUND_LEVEL - 11, GROUND_LEVEL - 9, GROUND_LEVEL - 8
platformWidth_L2_S2 BYTE 10, 9, 11, 7, 8, 9
wallX_L2_S2 BYTE 25, 55, 82
wallYTop_L2_S2 BYTE GROUND_LEVEL - 9, GROUND_LEVEL - 7, GROUND_LEVEL - 10
wallYBottom_L2_S2 BYTE GROUND_LEVEL - 1, GROUND_LEVEL, GROUND_LEVEL
springMushroomX_L2_S2 BYTE 40
springMushroomY_L2_S2 BYTE GROUND_LEVEL - 1

coinX_L3 BYTE 18, 19, 20, 48, 49, 50, 95, 96, 97, 105, 106, 107, 10, 11, 12
coinY_L3 BYTE GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 2, GROUND_LEVEL - 3, GROUND_LEVEL - 4
goomba1X_L3 BYTE 50
goomba1Y_L3 BYTE GROUND_LEVEL
platformX_L3 BYTE 8, 45, 92, 15, 78, 100
platformY_L3 BYTE GROUND_LEVEL - 11, GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 11, GROUND_LEVEL - 9, GROUND_LEVEL - 7
platformWidth_L3 BYTE 12, 9, 9, 7, 8, 6
wallX_L3 BYTE 35, 65, 88
wallYTop_L3 BYTE GROUND_LEVEL - 10, GROUND_LEVEL - 7, GROUND_LEVEL - 6
wallYBottom_L3 BYTE GROUND_LEVEL, GROUND_LEVEL - 2, GROUND_LEVEL - 1

; LEVEL 3 SCREEN 2 DATA
coinX_L3_S2 BYTE 12, 13, 14, 42, 43, 44, 85, 86, 87, 102, 103, 104, 15, 16, 17
coinY_L3_S2 BYTE GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 8, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 7, GROUND_LEVEL - 4, GROUND_LEVEL - 5, GROUND_LEVEL - 6, GROUND_LEVEL - 3, GROUND_LEVEL - 4, GROUND_LEVEL - 5
goomba1X_L3_S2 BYTE 60
goomba1Y_L3_S2 BYTE GROUND_LEVEL
platformX_L3_S2 BYTE 10, 40, 82, 20, 70, 95
platformY_L3_S2 BYTE GROUND_LEVEL - 13, GROUND_LEVEL - 7, GROUND_LEVEL - 8, GROUND_LEVEL - 12, GROUND_LEVEL - 10, GROUND_LEVEL - 9
platformWidth_L3_S2 BYTE 11, 10, 10, 8, 9, 7
wallX_L3_S2 BYTE 30, 60, 85
wallYTop_L3_S2 BYTE GROUND_LEVEL - 11, GROUND_LEVEL - 8, GROUND_LEVEL - 7
wallYBottom_L3_S2 BYTE GROUND_LEVEL, GROUND_LEVEL - 1, GROUND_LEVEL - 2
springMushroomX_L3_S2 BYTE 45
springMushroomY_L3_S2 BYTE GROUND_LEVEL - 1

; LEVEL 4 BOSS LEVEL DATA
coinX_L4 BYTE 20, 25, 30, 35, 40, 50, 55, 60, 70, 75, 80, 85, 90, 95, 100
coinY_L4 BYTE GROUND_LEVEL - 2, GROUND_LEVEL - 6, GROUND_LEVEL - 10, GROUND_LEVEL - 6, GROUND_LEVEL - 2, GROUND_LEVEL - 8, GROUND_LEVEL - 12, GROUND_LEVEL - 8, GROUND_LEVEL - 5, GROUND_LEVEL - 9, GROUND_LEVEL - 13, GROUND_LEVEL - 9, GROUND_LEVEL - 5, GROUND_LEVEL - 7, GROUND_LEVEL - 3
platformX_L4 BYTE 5, 25, 50, 35, 70, 90
platformY_L4 BYTE GROUND_LEVEL - 8, GROUND_LEVEL - 12, GROUND_LEVEL - 10, GROUND_LEVEL - 15, GROUND_LEVEL - 7, GROUND_LEVEL - 13
platformWidth_L4 BYTE 8, 12, 10, 8, 15, 10
wallX_L4 BYTE 18, 45, 82
wallYTop_L4 BYTE GROUND_LEVEL - 10, GROUND_LEVEL - 12, GROUND_LEVEL - 8
wallYBottom_L4 BYTE GROUND_LEVEL - 3, GROUND_LEVEL - 5, GROUND_LEVEL - 2

cloudCount = 5
cloudX BYTE 10, 35, 60, 85, 100
cloudY BYTE 8, 6, 7, 5, 9
cloudStr BYTE "o-o", 0

strTitle BYTE "SUPER MARIO BROS - 0525", 0
strWelcome BYTE "*** WELCOME TO SUPER MARIO BROS ***", 0
strMenuStart BYTE "1. START GAME", 0
strMenuHighscore BYTE "2. HIGHSCORE", 0
strMenuExit BYTE "3. EXIT", 0
strEnterChoice BYTE "ENTER YOUR CHOICE (1-3): ", 0
strEnterName BYTE "ENTER YOUR NAME: ", 0
strInvalidChoice BYTE "INVALID CHOICE! PRESS ANY KEY...", 0
strScore BYTE "SCORE:", 0
strCoins BYTE "COINS:", 0
strWorld BYTE "WORLD:", 0
strTime BYTE "TIME:", 0
strLife BYTE "LIFE:", 0
strBossHealth BYTE "BOSS HP:", 0
strGameOver BYTE "GAME OVER", 0
strYouDied BYTE "YOU DIED! PRESS ANY KEY", 0
strLevelComplete BYTE "LEVEL COMPLETE!", 0
strBossDefeated BYTE "BOSS DEFEATED!", 0
strAllComplete BYTE "ALL LEVELS COMPLETE!", 0
strPressAnyKey BYTE "PRESS ANY KEY TO START", 0
strNextLevel BYTE "PRESS ANY KEY FOR NEXT LEVEL", 0
strRestart BYTE "PRESS R TO RESTART OR X TO EXIT", 0
strScoreSaved BYTE "SCORE SAVED!", 0
strThankYou BYTE "THANK YOU FOR PLAYING!", 0
strPaused BYTE "GAME PAUSED", 0
strPauseInstruction BYTE "PRESS ESC TO RESUME OR X TO EXIT", 0
strBossWarning BYTE "*** BOSS BATTLE ***", 0
strBossPhase2 BYTE "BOSS ENRAGED!", 0
strLevelSelect BYTE "SELECT LEVEL (1-4):", 0
strInvalidLevel BYTE "INVALID LEVEL! PRESS ANY KEY...", 0
strNoScores BYTE "NO HIGH SCORES YET. PLAY A GAME!", 0
strHighscoreTitle BYTE "*** HIGH SCORES ***", 0
strHighestScore BYTE "HIGHEST SCORE: ", 0
strHighestScorerName BYTE "PLAYER: ", 0
ground BYTE "------------------------------------------------------------------------------------------------------------------------", 0

scoreFileName BYTE "scores.txt", 0
fileHandle DWORD ?
scoreBuffer BYTE 200 DUP(0)
existingScores BYTE 1000 DUP(0)
existingScoresLen DWORD 0
highestScoreName BYTE 50 DUP(0)

.code

main PROC
call Randomize

mainMenu :
call ShowWelcomeMenu
call GetPlayerName
call SelectLevel
call DrawTitleScreen
mov score, 0
mov coins, 0
mov lives, 3
mov timeLeft, 400
mov gameActive, 1

gameMainLoop:
call Clrscr

; Set background color based on level
mov al, level
cmp al, 1
je setLevel1Background
cmp al, 2
je setLevel2Background
cmp al, 3
je setLevel3Background
cmp al, 4
je setBossBackground
mov eax, DEFAULT_ATTR
jmp setColorDone
setLevel1Background:
mov eax, LEVEL1_ATTR
jmp setColorDone
setLevel2Background:
mov eax, LEVEL2_ATTR
jmp setColorDone
setLevel3Background:
mov eax, LEVEL3_ATTR
jmp setColorDone
setBossBackground :
mov eax, BOSS_ATTR
setColorDone :
call SetTextColor

call HandleInput
call UpdatePhysics
call UpdateGame

call DrawUI
call DrawClouds
call DrawLevel
call DrawPlayer
call DrawEnemies
call DrawKoopa
call DrawBoss
call DrawProjectiles
call DrawPowerUps
call DrawCoins

mov eax, 50
call Delay

cmp gameActive, 1
je gameMainLoop

call SaveScoreToFile
call ShowGameOver
cmp gameActive, 1
je mainMenu

call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strThankYou
call WriteString
mov dl, 45
mov dh, 14
call Gotoxy
mov edx, OFFSET strScoreSaved
call WriteString
mov eax, 2000
call Delay

exit
main ENDP

ShowWelcomeMenu PROC
push eax
push edx

menuLoop :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 42
mov dh, 8
call Gotoxy
mov edx, OFFSET strWelcome
call WriteString

mov dl, 52
mov dh, 12
call Gotoxy
mov edx, OFFSET strMenuStart
call WriteString

mov dl, 52
mov dh, 14
call Gotoxy
mov edx, OFFSET strMenuHighscore
call WriteString

mov dl, 52
mov dh, 16
call Gotoxy
mov edx, OFFSET strMenuExit
call WriteString

mov dl, 45
mov dh, 20
call Gotoxy
mov edx, OFFSET strEnterChoice
call WriteString

call ReadChar

cmp al, '1'
je startGame
cmp al, '2'
je showHighscore
cmp al, '3'
je exitProgram

mov dl, 42
mov dh, 22
call Gotoxy
mov edx, OFFSET strInvalidChoice
call WriteString
call ReadChar
jmp menuLoop

showHighscore :
call ShowHighscore
jmp menuLoop

startGame :
pop edx
pop eax
ret

exitProgram :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strThankYou
call WriteString
mov eax, 2000
call Delay
exit
ShowWelcomeMenu ENDP

ShowHighscore PROC
pushad

call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 8
call Gotoxy
mov edx, OFFSET strHighscoreTitle
call WriteString

mov edx, OFFSET scoreFileName
call OpenInputFile
mov fileHandle, eax
cmp eax, INVALID_HANDLE_VALUE
je noScores

mov edx, OFFSET existingScores
mov ecx, SIZEOF existingScores - 1
call ReadFromFile
mov existingScoresLen, eax
mov eax, fileHandle
call CloseFile

cmp existingScoresLen, 0
je noScores

mov esi, OFFSET existingScores
mov edi, 0
mov ebx, 0
mov edx, 0; Pointer to the start of the current name

parseLoop :
cmp edi, existingScoresLen
jge displayHighest

; Find 'Name:'
mov al, [esi]
cmp al, 'N'
jne findScore
mov al, [esi + 1]
cmp al, 'a'
jne findScore
mov al, [esi + 2]
cmp al, 'm'
jne findScore
mov al, [esi + 3]
cmp al, 'e'
jne findScore
mov al, [esi + 4]
cmp al, ':'
jne findScore

; Found "Name:", store pointer to the actual name
mov edx, esi
add edx, 6; Point past "Name: "

findScore:
mov al, [esi]
cmp al, 'S'
jne notScoreLine
mov al, [esi + 1]
cmp al, 'c'
jne notScoreLine
mov al, [esi + 2]
cmp al, 'o'
jne notScoreLine
mov al, [esi + 3]
cmp al, 'r'
jne notScoreLine
mov al, [esi + 4]
cmp al, 'e'
jne notScoreLine
mov al, [esi + 5]
cmp al, ':'
jne notScoreLine

add esi, 7
add edi, 7

xor ecx, ecx

convertLoop :
cmp edi, existingScoresLen
jge checkHighest

mov al, [esi]
cmp al, ','
je checkHighest
cmp al, 0Dh
je checkHighest
cmp al, '0'
jb notANumber
cmp al, '9'
ja notANumber

sub al, '0'
imul ecx, 10
add ecx, eax

inc esi
inc edi
jmp convertLoop

notANumber :
; If we hit something that's not a number, just continue parsing from the next line
jmp notHighest

checkHighest :
cmp ecx, ebx
jle notHighest
mov ebx, ecx

; New high score, so save the name
push esi; Save current position
push edi
mov esi, edx; Start of name
mov edi, OFFSET highestScoreName
; Copy name until ','
copyLoop:
mov al, [esi]
cmp al, ','
je endCopy
mov[edi], al
inc esi
inc edi
jmp copyLoop
endCopy :
mov byte ptr[edi], 0; Null - terminate the name
pop edi
pop esi

notHighest :
inc esi
inc edi
jmp parseLoop

notScoreLine :
inc esi
inc edi
jmp parseLoop

displayHighest :
mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strHighestScore
call WriteString
mov eax, ebx
call WriteDec

mov dl, 48
mov dh, 14
call Gotoxy
mov edx, OFFSET strHighestScorerName
call WriteString
mov edx, OFFSET highestScoreName
call WriteString

jmp endProc

noScores :
mov dl, 42
mov dh, 12
call Gotoxy
mov edx, OFFSET strNoScores
call WriteString

endProc :
mov dl, 42
mov dh, 20
call Gotoxy
mov edx, OFFSET strPressAnyKey
call WriteString
call ReadChar

popad
ret
ShowHighscore ENDP

GetPlayerName PROC
push eax
push ecx
push edx

call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 12
call Gotoxy
mov edx, OFFSET strEnterName
call WriteString

mov edx, OFFSET playerName
mov ecx, 49
call ReadString
mov nameLength, al

pop edx
pop ecx
pop eax
ret
GetPlayerName ENDP

SelectLevel PROC
push eax
push ecx
push edx

selectLevelLoop :
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor

mov dl, 48
mov dh, 10
call Gotoxy
mov edx, OFFSET strLevelSelect
call WriteString

mov dl, 50
mov dh, 12
call Gotoxy
mov al, '1'
call WriteChar
mov dl, 53
call Gotoxy
mov edx, OFFSET strMenuStart
call WriteString

mov dl, 50
mov dh, 14
call Gotoxy
mov al, '2'
call WriteChar
mov dl, 53
call Gotoxy
mov al, '-'
call WriteChar
mov al, ' '
call WriteChar
mov edx, OFFSET strWorld
call WriteString
mov al, ' '
call WriteChar
mov al, '2'
call WriteChar

mov dl, 50
mov dh, 16
call Gotoxy
mov al, '3'
call WriteChar
mov dl, 53
call Gotoxy
mov al, '-'
call WriteChar
mov al, ' '
call WriteChar
mov edx, OFFSET strWorld
call WriteString
mov al, ' '
call WriteChar
mov al, '3'
call WriteChar

mov dl, 50
mov dh, 18
call Gotoxy
mov al, '4'
call WriteChar
mov dl, 53
call Gotoxy
mov al, '-'
call WriteChar
mov al, ' '
call WriteChar
mov edx, OFFSET strBossWarning
call WriteString

call ReadChar

cmp al, '1'
je setLevel1
cmp al, '2'
je setLevel2
cmp al, '3'
je setLevel3
cmp al, '4'
je setLevel4

mov dl, 42
mov dh, 22
call Gotoxy
mov edx, OFFSET strInvalidLevel
call WriteString
call ReadChar
jmp selectLevelLoop

setLevel1 :
mov level, 1
jmp levelSelected

setLevel2 :
mov level, 2
jmp levelSelected

setLevel3 :
mov level, 3
jmp levelSelected

setLevel4 :
mov level, 4

levelSelected :
    mov al, level
    add al, 30h
    mov worldStr[2], al
    call LoadLevel

    pop edx
    pop ecx
    pop eax
    ret
    SelectLevel ENDP

    SaveScoreToFile PROC
    push eax
    push ebx
    push ecx
    push edx
    push esi
    push edi

    cmp nameLength, 0
    je saveError

    mov edx, OFFSET scoreFileName
    call OpenInputFile
    mov fileHandle, eax

    cmp eax, INVALID_HANDLE_VALUE
    je createNewFile

    mov edx, OFFSET existingScores
    mov ecx, 999
    call ReadFromFile
    mov existingScoresLen, eax

    mov eax, fileHandle
    call CloseFile

    mov edx, OFFSET scoreFileName
    call CreateOutputFile
    mov fileHandle, eax
    cmp eax, INVALID_HANDLE_VALUE
    je saveError

    mov eax, existingScoresLen
    cmp eax, 0
    je buildNewEntry

    push eax
    mov eax, fileHandle
    mov edx, OFFSET existingScores
    mov ecx, existingScoresLen
    call WriteToFile
    pop eax

    jmp buildNewEntry

    createNewFile :
mov edx, OFFSET scoreFileName
call CreateOutputFile
mov fileHandle, eax
cmp eax, INVALID_HANDLE_VALUE
je saveError

mov existingScoresLen, 0

buildNewEntry:
mov edi, OFFSET scoreBuffer

cmp existingScoresLen, 0
je noNewlineNeeded
mov al, 13
stosb
mov al, 10
stosb

noNewlineNeeded :
mov al, 'N'
stosb
mov al, 'a'
stosb
mov al, 'm'
stosb
mov al, 'e'
stosb
mov al, ':'
stosb
mov al, ' '
stosb

mov esi, OFFSET playerName
movzx ecx, nameLength
copyNameLoop :
cmp ecx, 0
je skipName
lodsb
cmp al, 0
je skipName
stosb
dec ecx
jmp copyNameLoop
skipName :

mov al, ','
stosb
mov al, ' '
stosb
mov al, 'S'
stosb
mov al, 'c'
stosb
mov al, 'o'
stosb
mov al, 'r'
stosb
mov al, 'e'
stosb
mov al, ':'
stosb
mov al, ' '
stosb

mov eax, score
cmp eax, 0
jne hasScore
mov al, '0'
stosb
jmp skipScoreConvert

hasScore :
mov ebx, 10
xor ecx, ecx
mov esi, OFFSET scoreBuffer
add esi, 100

digitLoop :
    xor edx, edx
    div ebx
    add dl, '0'
    mov[esi + ecx], dl
    inc ecx
    cmp eax, 0
    jne digitLoop

    writeDigits :
dec ecx
mov al, [esi + ecx]
stosb
cmp ecx, 0
jne writeDigits

skipScoreConvert :
mov al, ','
stosb
mov al, ' '
stosb
mov al, 'L'
stosb
mov al, 'e'
stosb
mov al, 'v'
stosb
mov al, 'e'
stosb
mov al, 'l'
stosb
mov al, ':'
stosb
mov al, ' '
stosb

movzx eax, level
add al, '0'
stosb

mov ecx, edi
sub ecx, OFFSET scoreBuffer

mov eax, fileHandle
mov edx, OFFSET scoreBuffer
call WriteToFile

mov eax, fileHandle
call CloseFile

push eax
push edx
mov dl, 45
mov dh, 22
call Gotoxy
mov edx, OFFSET strScoreSaved
call WriteString
mov eax, 500
call Delay
pop edx
pop eax

saveError :
pop edi
pop esi
pop edx
pop ecx
pop ebx
pop eax
ret
SaveScoreToFile ENDP

DrawTitleScreen PROC
call Clrscr
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 50
mov dh, 5
call Gotoxy
mov edx, OFFSET strTitle
call WriteString
mov dl, 0
mov dh, GROUND_LEVEL + 2
call Gotoxy
mov edx, OFFSET ground
call WriteString
mov dl, 55
mov dh, GROUND_LEVEL
call Gotoxy
mov eax, BLUE_MARIO
call SetTextColor
mov al, 'M'
call WriteChar
mov eax, DEFAULT_ATTR
call SetTextColor
mov dl, 48
mov dh, 20
call Gotoxy
mov edx, OFFSET strPressAnyKey
call WriteString
call ReadChar
ret
DrawTitleScreen ENDP

DrawUI PROC
mov al, level
cmp al, 4
je setBossUIColor
mov eax, DEFAULT_ATTR
jmp setUIColorDone
setBossUIColor :
mov eax, BOSS_ATTR
setUIColorDone :
call SetTextColor

mov dl, 5
mov dh, 1
call Gotoxy
mov edx, OFFSET strScore
call WriteString
mov dl, 5
mov dh, 2
call Gotoxy
mov eax, score
call WriteDec
mov dl, 20
mov dh, 1
call Gotoxy
mov edx, OFFSET strCoins
call WriteString
mov dl, 20
mov dh, 2
call Gotoxy
movzx eax, coins
call WriteDec
mov dl, 35
mov dh, 1
call Gotoxy
mov edx, OFFSET strWorld
call WriteString
mov dl, 35
mov dh, 2
call Gotoxy
mov edx, OFFSET worldStr
call WriteString
mov dl, 50
mov dh, 1
call Gotoxy
mov edx, OFFSET strTime
call WriteString
mov dl, 50
mov dh, 2
call Gotoxy
mov eax, timeLeft
call WriteDec
mov dl, 65
mov dh, 1
call Gotoxy
mov edx, OFFSET strLife
call WriteString
mov dl, 65
mov dh, 2
call Gotoxy
movzx eax, lives
call WriteDec

mov al, level
cmp al, 4
jne skipBossHP
cmp bossActive, 1
jne skipBossHP
mov dl, 80
mov dh, 1
call Gotoxy
mov edx, OFFSET strBossHealth
call WriteString
mov dl, 89
mov dh, 2
call Gotoxy
movzx eax, bossHealth
call WriteDec
skipBossHP :

mov dl, 0
mov dh, GROUND_LEVEL
call Gotoxy
mov edx, OFFSET ground
call WriteString
ret
DrawUI ENDP

DrawClouds PROC
mov ecx, cloudCount
mov esi, 0
cloudLoop:
test ecx, ecch
jz cloudsDone
mov dl, cloudX[esi]
mov dh, cloudY[esi]
call Gotoxy
mov edx, OFFSET cloudStr
call WriteString
inc esi
dec ecx
jmp cloudLoop
cloudsDone :
ret
DrawClouds ENDP

DrawLevel PROC
xor edi, edi
plLoop:
cmp edi, platformCount
jge plDone
mov dl, platformX[edi]
mov dh, platformY[edi]
call Gotoxy
movzx ecx, platformWidth[edi]
mov al, level
cmp al, 1
je drawLevel1Platform
cmp al, 2
je drawLevel2Platform
cmp al, 3
je drawLevel3Platform
jmp drawDefaultPlatform

drawLevel1Platform:
mov eax, BRICK_ATTR
call SetTextColor
mov al, 205
plInner:
call WriteChar
loop plInner
mov eax, LEVEL1_ATTR
call SetTextColor
jmp nextPlatform

drawLevel2Platform:
mov eax, BRICK_ATTR_L2
call SetTextColor
mov al, 205
plInner_L2:
call WriteChar
loop plInner_L2
mov eax, LEVEL2_ATTR
call SetTextColor
jmp nextPlatform

drawLevel3Platform:
mov eax, BRICK_ATTR_L3
call SetTextColor
mov al, 205
plInner_L3:
call WriteChar
loop plInner_L3
mov eax, LEVEL3_ATTR
call SetTextColor
jmp nextPlatform

drawDefaultPlatform:
mov al, '='
plInner2:
call WriteChar
loop plInner2
nextPlatform:
inc edi
jmp plLoop
plDone :

mov ecx, wallCount
xor esi, esi
wallLoop:
test ecx, ecch
jz wallsDone
mov al, wallYBottom[esi]
sub al, wallYTop[esi]
inc al
mov bl, wallYTop[esi]
push ecx
movzx ecx, al
mov al, level
cmp al, 1
je drawLevel1Wall
cmp al, 2
je drawLevel2Wall
cmp al, 3
je drawLevel3Wall
jmp drawDefaultWall

drawLevel1Wall:
mov eax, PIPE_ATTR
call SetTextColor
wallDrawVert:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, 186
call WriteChar
inc bl
loop wallDrawVert
mov eax, LEVEL1_ATTR
call SetTextColor
jmp nextWall

drawLevel2Wall:
mov eax, PIPE_ATTR_L2
call SetTextColor
wallDrawVert_L2:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, 186
call WriteChar
inc bl
loop wallDrawVert_L2
mov eax, LEVEL2_ATTR
call SetTextColor
jmp nextWall

drawLevel3Wall:
mov eax, PIPE_ATTR_L3
call SetTextColor
wallDrawVert_L3:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, 186
call WriteChar
inc bl
loop wallDrawVert_L3
mov eax, LEVEL3_ATTR
call SetTextColor
jmp nextWall

drawDefaultWall:
wallDrawVert2:
mov dl, wallX[esi]
mov dh, bl
call Gotoxy
mov al, '#'
call WriteChar
inc bl
loop wallDrawVert2
nextWall:
pop ecx
inc esi
dec ecx
jmp wallLoop
wallsDone :
; Reset text color to default for level 1
mov eax, LEVEL1_ATTR
call SetTextColor
ret
DrawLevel ENDP

DrawPlayer PROC
mov dl, marioX
mov dh, marioY
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1Mario
cmp al, 2
je drawLevel2Mario
cmp al, 3
je drawLevel3Mario
jmp drawDefaultMario

drawLevel1Mario:
mov eax, red + (lightBlue * 16)
call SetTextColor
jmp drawMario

drawLevel2Mario:
mov eax, yellow + (black * 16)
call SetTextColor
jmp drawMario

drawLevel3Mario:
mov eax, red + (lightGray * 16)
call SetTextColor
jmp drawMario

drawDefaultMario:
mov eax, BLUE_MARIO
call SetTextColor

drawMario:
mov al, 'M'
cmp hasSpringPower, 1
jne normalP
mov al, 'S'
normalP:
call WriteChar
mov al, level
cmp al, 1
je resetLevel1Color
cmp al, 2
je resetLevel2Color
cmp al, 3
je resetLevel3Color
jmp resetNormalColor

resetLevel1Color:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp drawPlayerDone

resetLevel2Color:
mov eax, LEVEL2_ATTR
call SetTextColor
jmp drawPlayerDone

resetLevel3Color:
mov eax, LEVEL3_ATTR
call SetTextColor
jmp drawPlayerDone

resetNormalColor:
mov eax, DEFAULT_ATTR
call SetTextColor
drawPlayerDone:
ret
DrawPlayer ENDP

DrawEnemies PROC
cmp goomba1Active, 1
jne skipG
mov dl, goomba1X
mov dh, goomba1Y
call Gotoxy
mov al, level
cmp al, 1
je drawLevel1Enemy
cmp al, 2
je drawLevel2Enemy
cmp al, 3
je drawLevel3Enemy
jmp drawDefaultEnemy

drawLevel1Enemy:
mov eax, brown + (lightBlue * 16)
call SetTextColor
jmp drawEnemy

drawLevel2Enemy:
mov eax, lightRed + (black * 16)
call SetTextColor
jmp drawEnemy

drawLevel3Enemy:
mov eax, brown + (lightGray * 16)
call SetTextColor
jmp drawEnemy

drawDefaultEnemy:
mov eax, DEFAULT_ATTR
call SetTextColor

drawEnemy:
mov al, 'G'
call WriteChar
mov al, level
cmp al, 1
je resetLevel1EnemyColor
cmp al, 2
je resetLevel2EnemyColor
cmp al, 3
je resetLevel3EnemyColor
jmp resetNormalEnemyColor

resetLevel1EnemyColor:
mov eax, LEVEL1_ATTR
call SetTextColor
jmp skipG

resetLevel2EnemyColor:
mov eax, LEVEL2_ATTR
call SetTextColor
jmp skipG

resetLevel3EnemyColor:
mov eax, LEVEL3_ATTR
call SetTextColor
jmp skipG

resetNormalEnemyColor:
mov eax, DEFAULT_ATTR
call SetTextColor
skipG:
ret
DrawEnemies ENDP

DrawKoopa PROC
pushad

; Only draw in level 1
mov al, level
cmp al, 1
jne koopaDrawDone

cmp koopaActive, 0
je koopaDrawDone

mov dl, koopaX
mov dh, koopaY
call Gotoxy

; Check if shell or normal
cmp koopaIsShell, 1
je drawShell

; Draw normal Koopa Troopa
mov eax, green + (lightBlue * 16)
call SetTextColor
mov al, 'K'
call WriteChar
jmp resetKoopaColor

drawShell:
; Draw shell
cmp koopaShellMoving, 1
je drawMovingShell
; Stationary shell
mov eax, lightGreen + (lightBlue * 16)
call SetTextColor
mov al, 'o'
call WriteChar
jmp resetKoopaColor

drawMovingShell:
; Moving shell
mov eax, yellow + (lightBlue * 16)
call SetTextColor
mov al, 'o'
call WriteChar

resetKoopaColor:
mov eax, LEVEL1_ATTR
call SetTextColor

koopaDrawDone:
popad
ret
DrawKoopa ENDP

DrawPowerUps PROC
